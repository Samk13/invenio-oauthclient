{# -*- coding: utf-8 -*-

  This file is part of Invenio.
  Copyright (C) 2015-2020 CERN.
  Copyright (C) 2024      KTH Royal Institute of Technology.

  Invenio is free software; you can redistribute it and/or modify it
  under the terms of the MIT License; see LICENSE file for more details.
#}

{%- extends config.OAUTHCLIENT_SETTINGS_TEMPLATE %}

{% from "invenio_oauthclient/_macros.html" import render_field %}

{% block page_body %}
<div class="ui centered grid rel-mb-2">
  <div class="row">
  {%- block signup_panel %}
  <div>
    {%- block signup_header %}
      <div class="ui center aligned header">
        <div class="content">
          <div class="ui hidden divider"></div>
          {%- block signup_app_icon %}
            {% if app_icon -%}
            <i class="{{app_icon}}"></i>
            {% endif %}
          {%- endblock %}
          <h3 class="ui header">
            {{ _('Sign-up with %(title)s!', title=app_title) }}
          </h3>
          <h5 class="ui grey header">
            {{ _('Fill in your details to complete your registration. You only have to do this once.') }}
          </h5>
          <div class="ui hidden divider"></div>
        </div>
    </div>
    {% endblock %}
    {%- block signup_form %}
    <form class="ui form" name="edit" method="post" role="form">
      {%- for field in form %}
        {{ render_field(field) }}
      {%- endfor %}
      <div class="ui hidden divider"></div>
      <button type="submit" class="ui fluid large signup submit button">
        <i class="ui edit outline icon"></i>{{ _('Complete registration') }}
      </button>
    </form>
    {%- endblock %}
  </div>
  {%- endblock %}
</div>
</div>
{% endblock %}

{% block javascript %}
{{ super() }}
<script>
  async function fetchAffiliations(query, callback) {
      const maxSuggestions = 3;
      try {
        const response = await fetch(`/api/affiliations?size=${maxSuggestions}&suggest=${query}`);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const data = await response.json();
      const suggestions = data.hits.hits.map(hit => hit.title.en);
      callback(suggestions);
    } catch (error) {
      console.error("Error fetching affiliations:", error);
      callback([]);
    }
  }

  function autocomplete(inputElement) {
    const cache = new Map();
    const debounceTimeout = 100;
    let debounceTimer;

    // Create and append the datalist element
    const datalist = document.createElement('datalist');
    datalist.id = "affiliations-list";
    document.body.appendChild(datalist);

    // Link the datalist to the input element
    inputElement.setAttribute('list', datalist.id);
    inputElement.addEventListener("input", handleInput);
    inputElement.addEventListener("keydown", handleTabPress);

    function handleInput() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        const query = inputElement.value.trim().toLowerCase();
        if (!query) return;

        if (cache.has(query)) {
          updateDatalist(cache.get(query));
        } else {
          fetchAffiliations(query, suggestions => {
            cache.set(query, suggestions);
            updateDatalist(suggestions);
          });
        }
      }, debounceTimeout);
    }

    function handleTabPress(e) {
      if (e.key === 'Tab' && datalist.options.length > 0) {
        inputElement.value = datalist.options[0].value;
      }
    }

    function updateDatalist(suggestions) {
      datalist.innerHTML = '';
      const fragment = document.createDocumentFragment();

      // Add suggestions to the datalist
      suggestions.forEach(suggestion => {
        const option = document.createElement('option');
        option.value = suggestion;
        fragment.appendChild(option);
      });
      datalist.appendChild(fragment);
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    const inputElement = document.getElementById("profile.affiliations");
    if (inputElement) {
      autocomplete(inputElement);
    } else {
      console.error('Input element with id "profile.affiliations" not found.');
    }
  });

</script>
{% endblock javascript %}